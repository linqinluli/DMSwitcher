## workload参考：

video/image processing: H.264 Video Encoding (FFmpeg)

deep learning: 模型推理/模型训练

OLTP: TPC-C（MySQL）
OLAP: TPC-H（Spark）

图计算（内存敏感）：bfs dfs等

常见应用：kmeans, quicksort等

## metric:

workload metric (每个workload各自的指标，比如数据库即单位查询数，每秒图像处理张数等)

page fault num

运行时间

内存随workload的运行变化

网络带宽

## 自变量:

local memory ratio：0% ~ 100%

## 实验流程：

分workload/分环境进行实验，需要在三个环境进行同样所有workload的实验

因为需要使用cgroup添加memory限制，cfm提供的bench有着完整的流程，且实现了page fault的查询，直接在workload中添加对应类（添加运行命令行即可），quicksort等简单的类可以直接使用cfm提供的bench

1. 系统对workload运行的影响
   
   进行内存限制(存在swap)，不进行内存限制（不存在swap）

| metric          | rdma backend(VM) | ssd backend(VM) | rdma backend(host) | ssd backend(host) |
|:---------------:|:----------------:|:---------------:|:------------------:|:-----------------:|
| time            | √                | √               | √                  | √                 |
| page fault      | √                | √               | √                  | √                 |
| network         | √                | ×               | √                  | ×                 |
| workload metric | √                | √               | √                  | √                 |

2. 应用特征测量（与内存后端类型无关）对应用标签化
   
   a. 应用运行过程中匿名页和文件页的实时比例
   
   b. 应用运行过程中的实时page fault（需要考虑，不超过内存限制较难page fault）
   
   c. 应用运行过程中的实时内存变化

3. 后端系统对workload的影响（local memory ratio，data block size，swap cache size）
   
   | parameter   | rdma | ssd |
   | ----------- | ---- | --- |
   | buffer size |      |     |
   |             |      |     |
   | chunk size  |      |     |
   |             |      |     |

| metric          | rdma backend(VM) | ssd backend(VM) |
|:---------------:|:----------------:|:---------------:|
| time            | √                | √               |
| page fault      | √                | √               |
| network         | √                | ×               |
| workload metric | √                | √               |
|                 |                  |                 |

**问题：**

1. cgroupv2目前我还没有挂载上
   
   挂载方式：
   
   在/etc/default/grub文件修改系统启动cmdline，末尾添加cgroup_no_v1=all
   
   运行 `sudo mkdir /cgroup2` 创建挂载点
   
   运行脚本文件挂载 `setup/init_bench_cgroups.sh`

2. 网络带宽的输出还没找到好的方案

3. 是否需要进行多workload并行运行的实验，由于虚拟机包裹起来，感觉意义不大

4. cgroup写入memory.high报错

```shell
[  169.720513] BUG: unable to handle kernel NULL pointer dereference at           (null)
[  169.720571] IP: _raw_spin_lock+0xc/0x30
[  169.720605] PGD 96c495067 
[  169.720605] PUD 96596a067 
[  169.720638] PMD 0 

[  169.720736] Oops: 0002 [#1] SMP
[  169.720774] Modules linked in: rdma_ucm(OE) ib_ucm(OE) ib_ipoib(OE) ib_uverbs(OE) ib_umad(OE) mlx5_fpga_tools(OE) mlx5_ib(OE) mlx4_ib(OE) mlx4_en(OE) mlx4_core(OE) snd_hda_codec_generic ppdev snd_hda_intel snd_hda_codec snd_hda_core snd_hwdep snd_pcm input_leds serio_raw snd_timer snd soundcore joydev lpc_ich parport_pc parport qemu_fw_cfg shpchp mac_hid ib_iser(OE) rdma_cm(OE) iw_cm(OE) ib_cm(OE) ib_core(OE) configfs iscsi_tcp libiscsi_tcp libiscsi scsi_transport_iscsi knem(OE) autofs4 btrfs raid10 raid456 async_raid6_recov async_memcpy async_pq async_xor async_tx xor raid6_pq libcrc32c raid1 raid0 multipath linear hid_generic usbhid hid crct10dif_pclmul crc32_pclmul ghash_clmulni_intel pcbc aesni_intel aes_x86_64 mlx5_core(OE) crypto_simd glue_helper mlxfw(OE) devlink cryptd ptp sym53c8xx pps_core
[  169.721224]  virtio_blk scsi_transport_spi mlx_compat(OE) qxl virtio_net ttm drm_kms_helper psmouse syscopyarea ahci sysfillrect libahci sysimgblt fb_sys_fops drm
[  169.721280] CPU: 2 PID: 1461 Comm: python Tainted: G           OE   4.11.0-fastswap #6
[  169.721300] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.10.2-1ubuntu1 04/01/2014
[  169.721320] task: ffff9bf1ec3a0000 task.stack: ffffba6546fdc000
[  169.721337] RIP: 0010:_raw_spin_lock+0xc/0x30
[  169.721351] RSP: 0018:ffffba6546fdfd28 EFLAGS: 00010046
[  169.721367] RAX: 0000000000000000 RBX: ffffffff867c8800 RCX: 0000000000000000
[  169.721385] RDX: 0000000000000001 RSI: 000000007fffffff RDI: 0000000000000000
[  169.721404] RBP: ffffba6546fdfd70 R08: 00000000000019c8 R09: 0000000000000004
[  169.721421] R10: 000000000000000a R11: f000000000000000 R12: 0000000000000007
[  169.721439] R13: ffff9bf1f3c06800 R14: ffff9bf1e96e8198 R15: 0000000000015e20
[  169.721457] FS:  00007f01118fb700(0000) GS:ffff9bf219100000(0000) knlGS:0000000000000000
[  169.721477] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[  169.721495] CR2: 0000000000000000 CR3: 0000000968404000 CR4: 00000000003406e0
[  169.721520] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[  169.721538] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[  169.721557] Call Trace:
[  169.721577]  ? __queue_work+0x33a/0x480
[  169.721594]  queue_work_on+0x27/0x40
[  169.721609]  memory_high_write+0xbf/0xd0
[  169.721624]  cgroup_file_write+0x3f/0x100
[  169.721640]  ? _copy_from_user+0x67/0x80
[  169.721656]  kernfs_fop_write+0x120/0x1a0
[  169.721672]  __vfs_write+0x37/0x160
[  169.721687]  ? apparmor_file_permission+0x1a/0x20
[  169.721703]  ? security_file_permission+0x3b/0xc0
[  169.721718]  vfs_write+0xb8/0x1b0
[  169.721732]  SyS_write+0x55/0xc0
[  169.721747]  entry_SYSCALL_64_fastpath+0x1e/0xad
[  169.721765] RIP: 0033:0x7f01114d74a0
[  169.722391] RSP: 002b:00007fff4c6285e8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001
[  169.722691] RAX: ffffffffffffffda RBX: 00007f0110db1b20 RCX: 00007f01114d74a0
[  169.722878] RDX: 0000000000000005 RSI: 0000000000d7ba00 RDI: 0000000000000004
[  169.723042] RBP: 0000000000001011 R08: 0000000000000000 R09: 0000000000000001
[  169.723199] R10: 0000000000000100 R11: 0000000000000246 R12: 0000000000002710
[  169.723356] R13: 00007f0110db1b78 R14: 00007f0110db1b78 R15: 0000000000000000
[  169.723511] Code: 00 01 00 00 f0 0f c1 37 81 c6 00 01 00 00 40 84 f6 75 01 c3 55 48 89 e5 e8 e2 3c 80 ff 5d c3 0f 1f 44 00 00 31 c0 ba 01 00 00 00 <f0> 0f b1 17 85 c0 75 01 c3 55 89 c6 48 89 e5 e8 10 24 80 ff 66 
[  169.723852] RIP: _raw_spin_lock+0xc/0x30 RSP: ffffba6546fdfd28
[  169.724016] CR2: 0000000000000000
[  169.724183] ---[ end trace 36f0dd45bb77005f ]---
```
